# Nexus\SSO - Architecture Diagrams

**Version:** 1.0  
**Created:** November 23, 2025

---

## ğŸ—ï¸ Package Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Nexus\SSO Package                           â”‚
â”‚                     (Framework-Agnostic Layer)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Contracts/       â”‚        â”‚   Services/        â”‚              â”‚
â”‚  â”‚                    â”‚        â”‚                    â”‚              â”‚
â”‚  â”‚ â€¢ SsoManagerIf     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚ â€¢ SsoManager       â”‚              â”‚
â”‚  â”‚ â€¢ SsoProviderIf    â”‚        â”‚ â€¢ AttributeMapper  â”‚              â”‚
â”‚  â”‚ â€¢ SamlProviderIf   â”‚        â”‚ â€¢ StateValidator   â”‚              â”‚
â”‚  â”‚ â€¢ OAuthProviderIf  â”‚        â”‚                    â”‚              â”‚
â”‚  â”‚ â€¢ UserProvisionIf  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚           â–²                                                          â”‚
â”‚           â”‚ implements                                               â”‚
â”‚           â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚          Providers/                            â”‚                â”‚
â”‚  â”‚                                                 â”‚                â”‚
â”‚  â”‚  â€¢ Saml2Provider       â€¢ AzureAdProvider        â”‚                â”‚
â”‚  â”‚  â€¢ OAuth2Provider      â€¢ GoogleWorkspaceProviderâ”‚                â”‚
â”‚  â”‚  â€¢ OidcProvider        â€¢ OktaProvider           â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  ValueObjects/     â”‚        â”‚   Exceptions/      â”‚              â”‚
â”‚  â”‚                    â”‚        â”‚                    â”‚              â”‚
â”‚  â”‚ â€¢ SsoProtocol      â”‚        â”‚ â€¢ SsoException     â”‚              â”‚
â”‚  â”‚ â€¢ UserProfile      â”‚        â”‚ â€¢ InvalidToken     â”‚              â”‚
â”‚  â”‚ â€¢ SsoSession       â”‚        â”‚ â€¢ ProvisioningErr  â”‚              â”‚
â”‚  â”‚ â€¢ AttributeMap     â”‚        â”‚                    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Dependency Injection
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Layer (consuming application)                         â”‚
â”‚                      (Laravel Integration)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Repositories/                                                â”‚  â”‚
â”‚  â”‚  â€¢ DbSsoConfigRepository (implements SsoConfigRepositoryIf)   â”‚  â”‚
â”‚  â”‚  â€¢ DbSsoSessionRepository (implements SsoSessionRepositoryIf) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services/SSO/                                                â”‚  â”‚
â”‚  â”‚  â€¢ IdentityUserProvisioner (implements UserProvisioningIf)    â”‚  â”‚
â”‚  â”‚  â€¢ RedisSsoStateStore (implements CallbackStateValidatorIf)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Models/                                                       â”‚  â”‚
â”‚  â”‚  â€¢ SsoProvider (Eloquent)                                      â”‚  â”‚
â”‚  â”‚  â€¢ SsoSession (Eloquent)                                       â”‚  â”‚
â”‚  â”‚  â€¢ SsoUserMapping (Eloquent)                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Http/Controllers/                                             â”‚  â”‚
â”‚  â”‚  â€¢ SsoController                                               â”‚  â”‚
â”‚  â”‚    - GET /sso/login/{provider}                                 â”‚  â”‚
â”‚  â”‚    - GET /sso/callback/{provider}                              â”‚  â”‚
â”‚  â”‚    - POST /sso/logout                                          â”‚  â”‚
â”‚  â”‚    - GET /sso/metadata/{provider}                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ SSO Authentication Flow (SAML 2.0)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚         â”‚  consuming application   â”‚         â”‚ Nexus\SSOâ”‚         â”‚   IdP    â”‚
â”‚ Browser  â”‚         â”‚ (Laravel)â”‚         â”‚ Package  â”‚         â”‚ (Azure)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 1. Click "Login    â”‚                    â”‚                    â”‚
     â”‚    with Azure AD"  â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 2. initiateLogin() â”‚                    â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
     â”‚                    â”‚   (provider='azure',â”‚                   â”‚
     â”‚                    â”‚    tenantId='T1')  â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 3. Generate state  â”‚
     â”‚                    â”‚                    â”‚    (CSRF token)    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 4. Build SAML      â”‚
     â”‚                    â”‚                    â”‚    AuthnRequest    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 5. Return authUrl  â”‚                    â”‚
     â”‚                    â”‚    + state token   â”‚                    â”‚
     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 6. Redirect to     â”‚                    â”‚                    â”‚
     â”‚    IdP login page  â”‚                    â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 7. SAML AuthnRequest                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 8. User enters credentials (Azure AD)   â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 9. Validate creds  â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 10. Sign SAML      â”‚
     â”‚                    â”‚                    â”‚     assertion      â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 11. SAML Response  â”‚                    â”‚                    â”‚
     â”‚    (signed assertion)                   â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 12. POST to        â”‚                    â”‚                    â”‚
     â”‚     /sso/callback/ â”‚                    â”‚                    â”‚
     â”‚     azure          â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 13. handleCallback()                    â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
     â”‚                    â”‚   (callbackData,   â”‚                    â”‚
     â”‚                    â”‚    state)          â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 14. Validate state â”‚
     â”‚                    â”‚                    â”‚     (CSRF check)   â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 15. Parse SAML     â”‚
     â”‚                    â”‚                    â”‚     assertion      â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 16. Verify         â”‚
     â”‚                    â”‚                    â”‚     signature      â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 17. Extract        â”‚
     â”‚                    â”‚                    â”‚     user profile   â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 18. Map attributes â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 19. UserProvisioning::                  â”‚
     â”‚                    â”‚     findOrCreateUser()                  â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ (Bridge to Nexus\Identity)              â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 20. Return SsoSession                   â”‚
     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 21. Create session â”‚                    â”‚
     â”‚                    â”‚     token          â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 22. Set cookie,    â”‚                    â”‚                    â”‚
     â”‚     redirect to    â”‚                    â”‚                    â”‚
     â”‚     dashboard      â”‚                    â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 23. Authenticated! â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
```

---

## ğŸ”„ SSO Authentication Flow (OAuth2/OIDC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚         â”‚  consuming application   â”‚         â”‚ Nexus\SSOâ”‚         â”‚   IdP    â”‚
â”‚ Browser  â”‚         â”‚ (Laravel)â”‚         â”‚ Package  â”‚         â”‚ (Google) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 1. Click "Login    â”‚                    â”‚                    â”‚
     â”‚    with Google"    â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 2. initiateLogin() â”‚                    â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 3. Generate state  â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 4. Build OAuth URL â”‚
     â”‚                    â”‚                    â”‚    with scope      â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 5. Return authUrl  â”‚                    â”‚
     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 6. Redirect to     â”‚                    â”‚                    â”‚
     â”‚    OAuth consent   â”‚                    â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 7. OAuth authorize request              â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 8. User consents   â”‚                    â”‚                    â”‚
     â”‚    (Google login)  â”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 9. Redirect with   â”‚                    â”‚                    â”‚
     â”‚    authorization   â”‚                    â”‚                    â”‚
     â”‚    code            â”‚                    â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 10. GET /sso/      â”‚                    â”‚                    â”‚
     â”‚     callback/googleâ”‚                    â”‚                    â”‚
     â”‚     ?code=ABC&stateâ”‚                    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 11. handleCallback()                    â”‚
     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 12. Validate state â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 13. Exchange code  â”‚
     â”‚                    â”‚                    â”‚     for token      â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 14. Return access  â”‚
     â”‚                    â”‚                    â”‚     token + ID tokenâ”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 15. Validate JWT   â”‚
     â”‚                    â”‚                    â”‚     ID token       â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 16. Get userinfo   â”‚
     â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 17. Return profile â”‚
     â”‚                    â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚ 18. Map attributes â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 19. UserProvisioning::                  â”‚
     â”‚                    â”‚     findOrCreateUser()                  â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 20. Return SsoSession                   â”‚
     â”‚                    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 21. Set cookie,    â”‚                    â”‚                    â”‚
     â”‚     redirect       â”‚                    â”‚                    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
```

---

## ğŸ§© Integration with Nexus\Identity

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       SSO Callback Handler                      â”‚
â”‚                      (Nexus\SSO\SsoManager)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 1. Extract UserProfile
                            â”‚    from IdP response
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  UserProfile  â”‚
                    â”‚  VO           â”‚
                    â”‚               â”‚
                    â”‚ â€¢ ssoUserId   â”‚
                    â”‚ â€¢ email       â”‚
                    â”‚ â€¢ firstName   â”‚
                    â”‚ â€¢ lastName    â”‚
                    â”‚ â€¢ attributes  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 2. Call UserProvisioningInterface
                            â”‚    findOrCreateUser()
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           IdentityUserProvisioner (consuming application Layer)                   â”‚
â”‚           (implements UserProvisioningInterface)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ findOrCreateUser(UserProfile, provider, tenantId)        â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 1. Check if SSO mapping exists                            â”‚   â”‚
â”‚  â”‚    SELECT * FROM sso_user_mappings                        â”‚   â”‚
â”‚  â”‚    WHERE sso_user_id = profile.ssoUserId                  â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 2. If YES â†’ return existing user_id                       â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 3. If NO â†’ Check if user exists by email                  â”‚   â”‚
â”‚  â”‚    UserRepository::findByEmail(profile.email)             â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 4a. If user exists â†’ Link SSO identity                    â”‚   â”‚
â”‚  â”‚     INSERT INTO sso_user_mappings (user_id, sso_user_id) â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 4b. If NO user â†’ JIT Provisioning                         â”‚   â”‚
â”‚  â”‚     UserManager::createUser({                             â”‚   â”‚
â”‚  â”‚       email: profile.email,                               â”‚   â”‚
â”‚  â”‚       first_name: profile.firstName,                      â”‚   â”‚
â”‚  â”‚       ...                                                  â”‚   â”‚
â”‚  â”‚     })                                                     â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 5. Assign default roles (from SSO config)                 â”‚   â”‚
â”‚  â”‚    RoleManager::assignRoles(userId, defaultRoles)         â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ 6. Return user_id                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 3. Return userId
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SsoSession   â”‚
                    â”‚  VO           â”‚
                    â”‚               â”‚
                    â”‚ â€¢ sessionId   â”‚
                    â”‚ â€¢ userId      â”‚
                    â”‚ â€¢ providerNameâ”‚
                    â”‚ â€¢ tenantId    â”‚
                    â”‚ â€¢ profile     â”‚
                    â”‚ â€¢ expiresAt   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Model (Application Layer)

```sql
-- SSO Provider Configuration
CREATE TABLE sso_providers (
    id CHAR(26) PRIMARY KEY,            -- ULID
    tenant_id CHAR(26) NOT NULL,        -- Multi-tenant isolation
    provider_name VARCHAR(50) NOT NULL, -- 'azure', 'google', 'saml', etc.
    protocol VARCHAR(20) NOT NULL,      -- 'saml2', 'oauth2', 'oidc'
    enabled BOOLEAN DEFAULT false,
    settings JSON NOT NULL,             -- Provider-specific config
    attribute_map JSON NOT NULL,        -- IdP â†’ local mapping
    jit_provisioning_enabled BOOLEAN DEFAULT true,
    default_roles JSON,                 -- ['user', 'employee']
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE KEY (tenant_id, provider_name)
);

-- SSO Sessions
CREATE TABLE sso_sessions (
    id CHAR(26) PRIMARY KEY,            -- ULID (session_id)
    user_id CHAR(26) NOT NULL,
    provider_name VARCHAR(50) NOT NULL,
    tenant_id CHAR(26) NOT NULL,
    profile JSON NOT NULL,              -- Cached user profile
    created_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
);

-- SSO User Mappings (link local users to SSO identities)
CREATE TABLE sso_user_mappings (
    id CHAR(26) PRIMARY KEY,            -- ULID
    user_id CHAR(26) NOT NULL,          -- Local user ID
    sso_user_id VARCHAR(255) NOT NULL,  -- IdP user identifier (Azure Object ID, Google sub, etc.)
    provider_name VARCHAR(50) NOT NULL, -- 'azure', 'google', etc.
    tenant_id CHAR(26) NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE KEY (sso_user_id, provider_name, tenant_id),
    INDEX idx_user_id (user_id)
);
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layers                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. TRANSPORT SECURITY                                       â”‚
â”‚     â”œâ”€ HTTPS only (TLS 1.2+)                                â”‚
â”‚     â””â”€ Strict-Transport-Security header                     â”‚
â”‚                                                              â”‚
â”‚  2. CSRF PROTECTION                                          â”‚
â”‚     â”œâ”€ State token validation                               â”‚
â”‚     â”œâ”€ One-time use tokens                                  â”‚
â”‚     â””â”€ 10-minute expiry                                     â”‚
â”‚                                                              â”‚
â”‚  3. SIGNATURE VALIDATION                                     â”‚
â”‚     â”œâ”€ SAML assertion signature (RSA-SHA256)                â”‚
â”‚     â”œâ”€ JWT ID token signature (RS256/ES256)                 â”‚
â”‚     â””â”€ X.509 certificate validation                         â”‚
â”‚                                                              â”‚
â”‚  4. SESSION SECURITY                                         â”‚
â”‚     â”œâ”€ Secure, HttpOnly cookies                             â”‚
â”‚     â”œâ”€ Session expiry (1 hour)                              â”‚
â”‚     â””â”€ Session fixation prevention                          â”‚
â”‚                                                              â”‚
â”‚  5. TENANT ISOLATION                                         â”‚
â”‚     â”œâ”€ SSO configs scoped by tenant_id                      â”‚
â”‚     â”œâ”€ No cross-tenant SSO session access                   â”‚
â”‚     â””â”€ User mappings scoped by tenant_id                    â”‚
â”‚                                                              â”‚
â”‚  6. AUDIT LOGGING                                            â”‚
â”‚     â”œâ”€ All SSO login attempts                               â”‚
â”‚     â”œâ”€ JIT provisioning events                              â”‚
â”‚     â”œâ”€ Failed authentication (reason logged)                â”‚
â”‚     â””â”€ Configuration changes                                â”‚
â”‚                                                              â”‚
â”‚  7. RATE LIMITING                                            â”‚
â”‚     â”œâ”€ SSO callback endpoints (10 req/min per IP)           â”‚
â”‚     â””â”€ Login initiation (20 req/min per user)               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Performance Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Performance Optimizations                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. CACHING                                                  â”‚
â”‚     â”œâ”€ SSO provider configs (Redis, 1 hour TTL)             â”‚
â”‚     â”œâ”€ SAML metadata (Redis, 24 hour TTL)                   â”‚
â”‚     â””â”€ User profiles (Redis, 15 min TTL)                    â”‚
â”‚                                                              â”‚
â”‚  2. STATE STORAGE                                            â”‚
â”‚     â”œâ”€ Redis for state tokens (10 min TTL)                  â”‚
â”‚     â””â”€ Distributed, stateless validation                    â”‚
â”‚                                                              â”‚
â”‚  3. SESSION STORAGE                                          â”‚
â”‚     â”œâ”€ Redis for SSO sessions                               â”‚
â”‚     â””â”€ Database fallback for persistence                    â”‚
â”‚                                                              â”‚
â”‚  4. DATABASE OPTIMIZATION                                    â”‚
â”‚     â”œâ”€ Indexes on sso_user_id, user_id                      â”‚
â”‚     â”œâ”€ Composite index on (tenant_id, provider_name)        â”‚
â”‚     â””â”€ Partitioning for large sso_sessions table            â”‚
â”‚                                                              â”‚
â”‚  5. HTTP CLIENT                                              â”‚
â”‚     â”œâ”€ Connection pooling (Guzzle)                          â”‚
â”‚     â”œâ”€ Timeout configuration (5s connect, 10s read)         â”‚
â”‚     â””â”€ Retry logic (circuit breaker pattern)                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Document Version:** 1.0  
**Last Updated:** November 23, 2025  
**Status:** âœ… Ready for Implementation
